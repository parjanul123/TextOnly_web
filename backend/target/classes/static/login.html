<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>Autentificare QR</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; }
        .centered { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        #qrcode { margin: 32px 0; }
        h2 { color: #1976d2; }
    </style>
</head>
<body>
    <div class="centered">
        <h2>Scanează acest cod QR cu aplicația de pe telefon pentru login</h2>
        <div id="qrcode"></div>
        <button id="downloadQR" style="display:none;margin-bottom:20px;">Descarcă QR</button>
        <div id="status" style="color:red;"></div>
    </div>
    <script>
    // Funcție care detectează dacă QR-ul a fost scanat și login-ul a reușit
    function checkQrScanned(token, onSuccess) {
        const poll = setInterval(() => {
            fetch('/api/auth/qr/status/' + token)
                .then(res => res.json())
                .then(validated => {
                    if (validated) {
                        clearInterval(poll);
                        if (typeof onSuccess === 'function') onSuccess();
                    }
                })
                .catch(() => {
                    document.getElementById('status').innerText = 'Eroare la verificarea statusului QR!';
                });
        }, 2000);
    }

    // Generează token QR de la backend
    fetch('/api/auth/qr', {method: 'POST'})
      .then(res => {
        if (!res.ok) throw new Error('Backend indisponibil');
        return res.json();
      })
      .then(data => {
        const token = data.token || data.qrToken || data.id || data.sessionId;
        if (!token) throw new Error('Token QR lipsă din răspuns!');
        sessionStorage.setItem('qrToken', token);
        console.log('TOKEN QR:', token);
        // Pentru deep link corect:
        const qrLink = `textonly://login?token=${token}`;
        const canvas = document.createElement('canvas');
        QRCode.toCanvas(canvas, qrLink, function (error) {
          if (!error) {
            document.getElementById('qrcode').appendChild(canvas);
            const btn = document.getElementById('downloadQR');
            btn.style.display = 'block';
            btn.onclick = function() {
              const link = document.createElement('a');
              link.download = 'qr-login.png';
              link.href = canvas.toDataURL();
              link.click();
            };
          } else {
            document.getElementById('status').innerText = 'Eroare la generarea codului QR!';
          }
        });
        // Folosește funcția pentru polling și redirect
        checkQrScanned(token, function() {
            document.getElementById('status').innerText = 'Autentificare reușită!';
            setTimeout(() => {
                window.location.href = 'chat.html';
            }, 1000);
        });
      })
      .catch(err => {
        document.getElementById('status').innerText = 'Eroare: ' + err.message;
        // fallback QR static demo
        const fallback = 'https://textonly.ro/login';
        const canvas = document.createElement('canvas');
        QRCode.toCanvas(canvas, fallback, function (error) {
          if (!error) {
            document.getElementById('qrcode').appendChild(canvas);
          }
        });
      });
    </script>
</body>
</html>
