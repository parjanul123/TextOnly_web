<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <title>TextOnly - Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; }
        .header {
            <div class="header">
                <span class="header-title">TextOnly</span>
                <button class="settings-btn" onclick="goToProfile()">
                    <i class="fa fa-cog fa-lg"></i>
                </button>
                <button style="margin-left:16px; background:#b71c1c; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;" onclick="logout()">Logout</button>
            </div>
            <div style="padding: 0 16px;">
                <input class="search-bar" type="text" placeholder="Caută conversații..." id="searchBar" />
                <ul class="chat-list" id="chatList"></ul>
                <div id="emptyMsg" class="empty-msg" style="display:none;">Nu există conversații</div>
            </div>
            <script>
                    function logout() {
                            fetch('/api/auth/qr/logout', {method: 'POST'})
                                .then(() => window.location.href = 'login.html');
                    }
            function goToProfile() {
                window.location.href = 'profile.html';
            }
                        // Verifică tokenul QR din sessionStorage
                        const qrToken = sessionStorage.getItem('qrToken');
                        if (!qrToken) {
                                window.location.href = 'login.html';
                        } else {
                                // Validează tokenul la backend și preia datele doar dacă e validat
                                fetch('/api/auth/qr/status/' + qrToken)
                                    .then(res => res.json())
                                    .then(validated => {
                                        if (!validated) {
                                                window.location.href = 'login.html';
                                                return;
                                        }
                                        // Preia numărul de telefon asociat tokenului validat
                                        fetch('/api/auth/qr/session?token=' + qrToken)
                                            .then(res => res.json())
                                            .then(data => {
                                                const phoneNumber = data.phoneNumber;
                                                if (!phoneNumber) {
                                                        window.location.href = 'login.html';
                                                        return;
                                                }
                                                // Preia conversațiile reale pentru utilizatorul logat
                                                fetch('/api/messages/' + phoneNumber)
                                                    .then(res => res.json())
                                                    .then(chats => {
                                                        renderChats(chats);
                                                    });
                                            });
                                    });
                        }
            function renderChats(list) {
                const ul = document.getElementById('chatList');
                ul.innerHTML = '';
                if (!list || list.length === 0) {
                    document.getElementById('emptyMsg').style.display = 'block';
                } else {
                    document.getElementById('emptyMsg').style.display = 'none';
                    list.forEach(chat => {
                        const li = document.createElement('li');
                        li.innerHTML = `<div class="avatar">${chat.from[0]}</div><div class="chat-info"><div class="chat-name">${chat.from}</div><div class="last-message">${chat.content}</div></div>`;
                        ul.appendChild(li);
                    });
                }
            }
            document.getElementById('searchBar').addEventListener('input', function() {
                const val = this.value.toLowerCase();
                // Filtrare locală după nume sau conținut
                const items = Array.from(document.querySelectorAll('.chat-list li'));
                items.forEach(li => {
                    li.style.display = li.textContent.toLowerCase().includes(val) ? '' : 'none';
                });
            });
            </script>
            background: #1976d2;
            color: #fff;
            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh;">
                <h2>Accesul la chat nu este permis fără autentificare QR!</h2>
                <p>Te rugăm să te autentifici cu telefonul pentru a vedea conversațiile reale.</p>
                <button onclick="window.location.href='login.html'">Autentificare QR</button>
            </div>
            font-size: 20px;
